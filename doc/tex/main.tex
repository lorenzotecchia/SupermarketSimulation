\documentclass[a4paper, 12pt]{article}
\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{graphicx}
\usepackage{fancyhdr}
\usepackage{listings, xcolor}
\usepackage{enumitem}
\usepackage{aeguill}
\usepackage{tikz}
\usepackage{environ}
\makeatletter
\newsavebox{\measure@tikzpicture}
\NewEnviron{scaletikzpicturetowidth}[1]{%
  \def\tikz@width{#1}%
  \def\tikzscale{1}\begin{lrbox}{\measure@tikzpicture}%
  \BODY
  \end{lrbox}%
  \pgfmathparse{#1/\wd\measure@tikzpicture}%
  \edef\tikzscale{\pgfmathresult}%
  \BODY
}
\makeatother
\setitemize{noitemsep,topsep=0pt,parsep=0pt,partopsep=0pt}
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}
\pagestyle{fancy}
\fancyhf{}
\lhead{\textit{Laboratorio di Sistemi Operativi - SupermarketSimulation}}
\rfoot{\thepage}
\renewcommand{\headrulewidth}{0.5pt}
\renewcommand{\footrulewidth}{0.5pt}

\begin{document}

\definecolor{plantucolor0000}{RGB}{34,34,34}
\definecolor{plantucolor0001}{RGB}{241,241,241}
\definecolor{plantucolor0002}{RGB}{24,24,24}
\definecolor{plantucolor0003}{RGB}{0,0,0}

\begin{titlepage}

    \begin{center}
        \includegraphics[scale=0.4]{Images/logo-federico-II.pdf} 
    \end{center}

    \thispagestyle{empty}

    \center

    \textsc{\large Università degli studi di Napoli Federico II}

    \vspace{0.5in}

    \noindent\makebox[\linewidth]{\rule{\linewidth}{1.2pt}}
    \textsc{ \textbf{\large Supermarket Simulation }}
    \noindent\makebox[\linewidth]{\rule{\linewidth}{1.2pt}}

    \vspace{0.5in}

    \begin{minipage}{0.30\textwidth}
        \begin{flushleft}
            Francesco Terrecuso \\
            N86004191
        \end{flushleft}
    \end{minipage}
    \begin{minipage}{0.30\textwidth}
        \begin{center}
            Lorenzo Tecchia \\
            N86004446
        \end{center}
    \end{minipage}
    \begin{minipage}{0.35\textwidth}
        \begin{flushright}
            Simone Parente Martone \\
            N86004297
        \end{flushright}
    \end{minipage}

    \vspace{2in}

    \textbf{\large Department of Computer Science} \\

    \today

\end{titlepage}

\newpage

\section{Introduzione}
Questo è un documento di presentazione per un progetto sviluppato per l'esame di Laboratorio di 
Sistemi Operativi, A.A 2023/2024, tenuto dalla Prof. Rossi Alessandra.  \\
Il progetto consiste nella simulazione di un supermercato, modellando le 
interazioni tra quest'ultimo, i clienti e le casse in un contesto multi-threaded. 
Questo file si divide in diverse sezioni che forniscono una panoramica dei 
requisiti, delle scelte architetturali e implementative adottate.
\section{Requisiti identificati}
Il progetto prevede la realizzazione di un architettura client-server che simuli 
un supermercato dotato di $K$ casse e avente un limite di $C$ clienti presenti 
contemporaneamente all'interno. \\
All'inizio della simulazione, $C$ clienti entrano nel supermercato 
simultaneamente, successivamente, ogni volta che escono $E$ clienti, possono 
entrarne altri $E$. \\
Ogni cliente ha un tempo variabile dedicato agli acquisti, una volta scaduto questo
tempo, il cliente si mette in fila per pagare, attendendo il proprio turno.
Ultimato il pagamento, il cliente esce dal supermercato. \\
Ogni cassa è gestita da un cassiere che serve i clienti in base a una politica FIFO,
il tempo di servizio è dato da:
\begin{itemize}[noitemsep,topsep=0pt,parsep=0pt,partopsep=0pt]
    \item una componente costante, specifica per ogni cassiere
    \item una componente variabile, linearmente dipendente dal numero di acquisti
\end{itemize}


\section{Scelte architetturali}
L'architettura del sistema si basa sul modello client-server. \\
Sia il client che il server saranno sviluppati in C. Il server gestisce il
funzionamento del supermercato e delle casse, mentre i client simulano il 
comportamento dei clienti: entrano, fanno acquisti e una volta effettuato il 
pagamento, escono dal supermercato. \\
La gestione del supermercato sarà implementata tramite l'uso di thread multipli
per garantire una simulazione fluida e ottimizzata delle operazioni.
Prevediamo l'utilizzo di:
\begin{itemize}[noitemsep,topsep=0pt,parsep=0pt,partopsep=0pt]
    \item Un thread per la supervisione del supermercato.
    \item Un thread per ogni cassa.
    \item Un thread per ogni cliente all'interno del supermercato.
\end{itemize}

La scelta di utilizzare thread invece di processi è stata presa per evitare di
gravare eccessivamente sul sistema, minimizzando l'uso delle risorse e garantendo
migliori prestazioni. \\
L'accesso esclusivo al supermercato e alle casse sarà garantito dall'utilizzo di 
mutex, che assicureranno la sincronizzazione tra i thread, evitando race conditions
e conflitti. \\
La scelta della cassa non è svolta autonomamente dal cliente, bensì dal supermercato:
se la cassa è vuota, il cliente viene assegnato a questa cassa, altrimenti viene
assegnato alla cassa con meno clienti in coda.

\section{Componenti della simulazione}

\subsection{Clienti}
I clienti vengono creati e ammessi al supermercato fino ad un numero prestabilito
passato come parametro in fase di esecuzione, i clienti che proveranno ad accedere
successivamente saranno messi in una lista d'attesa. \\
Ogni cliente ha il seguente workflow:

\begin{itemize}[noitemsep,topsep=0pt,parsep=0pt,partopsep=0pt]
    \item \textbf{Fase di acquisto}: i clienti passano un tempo generato casualmente
        tra 0 e 190 secondi in questa fase, scegliendo un numero di articoli compreso
        tra 0 e 19.
    \item \textbf{Coda alle casse}: il cliente rimane in attesa.
    \item \textbf{Pagamento}: il cliente viene servito e attende un tempo
        variabile.
    \item \textbf{Uscita dal supermercato}: ultimato il pagamento, il cliente esce dal
        supermercato, chiudendo la connessione.

\end{itemize}

Ai clienti viene affidato un ID, che non viene generato casualmente, potenzialmente incorrendo in conflitti tra l'associazione univoca di clienti ed ID. Si è risolto tale problema attraverso l'associazione del file  descriptor delle socket al id del client. Essendo le socket uniche per ogni cliente che prova ad accedere al supermercato, si mantiene l'unicità dell'id cliente.


\subsection{Casse}
Il numero di casse è definito all'avvio del server, ogni cassa opera in 
maniera indipendente, con una propria coda e parametri generati casualmente.
Il tempo totale di servizio è calcolato tramite un tempo fisso sommato al prodotto tra
un modificatore casuale e il numero di oggetti del cliente.
Una volta terminato il servizio di un cliente, la cassa serve il cliente successivo,
in caso la coda fosse vuota la cassa rimarrebbe inattiva ed in attesa di altri clienti.

\newpage

\subsection{Supermercato}
Il supermercato viene inizializzato all'avvio del server, il numero di casse e di clienti
che possono trovarsi all'interno simultaneamente sono valori dati in fase di esecuzione.
È dotato di una coda esterna, in cui i clienti attendono che il numero di clienti all'interno
scenda sotto una certa soglia prima di poter entrare.
Il supermercato si occupa di gestire la scelta della cassa a cui assegnare il clientee  lo shift
dei clienti in avanti a quella determinata cassa.
\section{Funzionalità}
Vengono qui riportate tre delle funzioni principali della simulazione del Supermarket. In particolare la funzioni di:
\begin{itemize}[noitemsep,topsep=0pt,parsep=0pt,partopsep=0pt]
    \item Servi Cliente: Accede alla struttura dati cassa, mettendo i clienti in fila
    \item Supervisiona Supermercato: Accede alla struttura dati supermercato, verificando il numero di clienti presenti all'interno del supermercato
    \item Client Handler: Associa l'id univoco ad ogni cliente e inzializza i parametri di sumulazione per ogni cliente, quali numero di oggetti da comprare, tempo da passare nel supermercato prima di mettersi in fila.
\end{itemize}
\subsection{Servi Cliente}
\lstinputlisting[caption=Servi Cliente,
    label={lst:listing-servi_cliente},
    language=C++,
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    keepspaces=true,                 
    numbers=left,       
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2,
]{./Programmi/servi_cliente.c}
\subsection{Supervisiona Supermercato}
\lstinputlisting[caption=Supervisiona Supermercato,
    label={lst:listing-supervisiona_supermercato},
    language=C++,
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    keepspaces=true,                 
    numbers=left,       
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2,
]{./Programmi/supervisiona_supermercato.c}

\subsection{Client Handler}

\lstinputlisting[caption=Client Handler,
    label={lst:listing-client_handler},
    language=C++,
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    keepspaces=true,                 
    numbers=left,       
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2,
]{./Programmi/client_handler.c}

\newpage

\subsection{Activity Diagram per la funzione client\_handler}
\begin{figure}[h!]
\centering
\includegraphics[width=70mm,scale=0.5]{Images/client_handler.png}
\caption{Activity Diagram di client\_handler}
\label{fig:activity-diagram}
\end{figure}
\end{document}

\section{Cronologia lavoro}
\begin{center}
    \begin{tabular}{|c|c|c|}
        \hline
        \textbf{Data} & \textbf{Autore/i} & \textbf{Descrizione} \\
        \hline
        November 12, 2024 & Simone Parente Martone & Adattamento della prima versione \\
        \hline
        {\today} & Lorenzo Tecchia & Revisione e seconda versione \\
        \hline
    \end{tabular}
\end{center}

\end{document}
